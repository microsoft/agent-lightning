name: Examples - ADK
permissions:
  contents: read
on:
  schedule:
    # Every day at 4 AM UTC+8
    - cron: '0 20 * * *'

  workflow_dispatch:

  repository_dispatch:
    types: [ci-adk, ci-all]

run-name: >-
  ${{ github.event_name == 'repository_dispatch'
      && format(
        'PR #{0} - Label {1} - {2}',
        github.event.client_payload.pull_number,
        github.event.client_payload.ci_label,
        github.event.client_payload.correlation_id
      )
      || format('ADK - {0}', github.event_name) }}

jobs:
  adk:
    if: >
      github.event_name != 'repository_dispatch' ||
      github.event.action == 'ci-adk' ||
      github.event.action == 'ci-all'
    name: ADK (Python 3.12)
    runs-on: [self-hosted, 1ES.Pool=agl-runner-gpu]
    timeout-minutes: 30
    steps:
      - name: Check GPU status
        run: nvidia-smi

      - name: Check disk space
        run: df -h

      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.pr_ref || (github.event.pull_request.number && format('refs/pull/{0}/merge', github.event.pull_request.number)) || github.ref }}

      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          python-version: '3.12'

      - name: Sync dependencies
        run: |
          uv sync --frozen --no-default-groups --extra verl \
            --group dev --group experiment --group agents --group torch-gpu-stable

      - name: Freeze dependencies
        run: |
          set -ex
          uv pip freeze | tee requirements-freeze.txt
          echo "UV_LOCKED=1" >> $GITHUB_ENV
          echo "UV_NO_SYNC=1" >> $GITHUB_ENV

      - name: Upload dependencies artifact
        uses: actions/upload-artifact@v4
        with:
          name: dependencies-adk
          path: requirements-freeze.txt
          compression-level: 0

      - name: Launch LiteLLM Proxy
        run: ./scripts/litellm_run.sh
        env:
          AZURE_API_BASE: ${{ secrets.AZURE_GROUP_SUBSCRIPTION_API_BASE }}
          AZURE_API_KEY: ${{ secrets.AZURE_GROUP_SUBSCRIPTION_API_KEY }}

      - name: Prepare ADK dataset
        run: |
          set -ex
          cd examples/google_adk
          uv run python prepare_dataset.py --download --outdir .

      - name: ADK debug sanity check
        run: |
          set -ex
          cd examples/google_adk
          uv run python adk_debug.py --file data/test.parquet --index 0
        env:
          OPENAI_API_BASE: http://localhost:12306/
          OPENAI_API_KEY: dummy
          OPENAI_MODEL: meta-llama/Meta-Llama-3-8B-Instruct
        if: success() || failure()
