# Agent-Lightning æ–°æ‰‹å…¥é—¨æŒ‡å—


## ğŸ“‹ ç¬¬0æ­¥ï¼šå®‰è£…ä¾èµ–ï¼š

```bash
uv sync --frozen \
    --extra apo \
    --extra verl \
    --group dev \
    --group torch-gpu-stable \
    --group trl \
    --group agents \
    --no-default-groups
```

## ğŸ“‹ ç¬¬ä¸€æ­¥ï¼šéªŒè¯å®‰è£…

é¦–å…ˆï¼Œè®©æˆ‘ä»¬ç¡®è®¤ä¸€åˆ‡å®‰è£…æ­£ç¡®ï¼š

```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate

# æˆ–è€…ä½¿ç”¨ uv run å‰ç¼€
uv run python -c "import agentlightning as agl; print(f'Agent-Lightning ç‰ˆæœ¬: {agl.__version__}')"

# æ£€æŸ¥ CLI å·¥å…·æ˜¯å¦å¯ç”¨
uv run agl --help
```
ä½ åº”è¯¥èƒ½çœ‹åˆ° `agl` å‘½ä»¤çš„å¸®åŠ©ä¿¡æ¯ï¼ŒåŒ…æ‹¬ `store`ã€`vllm` ç­‰å­å‘½ä»¤ã€‚


## ğŸ¯ ç¬¬äºŒæ­¥ï¼šç†è§£æ ¸å¿ƒæ¦‚å¿µ

åœ¨å¼€å§‹è¿è¡Œä»£ç ä¹‹å‰ï¼Œå…ˆç†è§£å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š

### 1. **Agentï¼ˆæ™ºèƒ½ä½“ï¼‰**
   - è¿™æ˜¯ä½ è¦è®­ç»ƒçš„å¯¹è±¡ï¼Œå¯ä»¥æ˜¯ä»»ä½• AI æ™ºèƒ½ä½“
   - æ”¯æŒå¤šç§æ¡†æ¶ï¼šLangChainã€OpenAI Agent SDKã€AutoGenã€CrewAI ç­‰
   - ç”šè‡³å¯ä»¥ä¸ä½¿ç”¨æ¡†æ¶ï¼Œç›´æ¥ç”¨ Python + OpenAI

### 2. **Rolloutï¼ˆè¿è¡Œï¼‰**
   - ä¸€æ¬¡å®Œæ•´çš„ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹
   - æ¯ä¸ª rollout åŒ…å«ä¸€ä¸ªä»»åŠ¡è¾“å…¥å’Œä¸€æ¬¡å°è¯•

### 3. **Traceï¼ˆè¿½è¸ªï¼‰**
   - è®°å½•æ™ºèƒ½ä½“æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æ‰€æœ‰æ“ä½œ
   - åŒ…æ‹¬ LLM è°ƒç”¨ã€å·¥å…·ä½¿ç”¨ã€å¥–åŠ±ç­‰
   - åŸºäº OpenTelemetry æ ‡å‡†

### 4. **Storeï¼ˆå­˜å‚¨ï¼‰**
   - LightningStore å­˜å‚¨æ‰€æœ‰çš„ tracesã€rollouts å’Œèµ„æº
   - å¯ä»¥æ˜¯å†…å­˜å­˜å‚¨ï¼ˆInMemoryLightningStoreï¼‰æˆ–æœåŠ¡å™¨å­˜å‚¨

### 5. **Algorithmï¼ˆç®—æ³•ï¼‰**
   - ä» traces ä¸­å­¦ä¹ å¹¶ä¼˜åŒ–æ™ºèƒ½ä½“
   - æ”¯æŒå¼ºåŒ–å­¦ä¹ ï¼ˆVERLï¼‰ã€è‡ªåŠ¨æç¤ºä¼˜åŒ–ï¼ˆAPOï¼‰ç­‰

## ğŸš€ ç¬¬ä¸‰æ­¥ï¼šè¿è¡Œ Calc-X ç¤ºä¾‹

è®©æˆ‘ä»¬ä» Calc-X æ•°å­¦æ¨ç†æ™ºèƒ½ä½“ç¤ºä¾‹å¼€å§‹ï¼Œç†è§£åŸºæœ¬å·¥ä½œæµç¨‹ã€‚

### å‰ç½®å‡†å¤‡

é¦–å…ˆå®‰è£… Calc-X ç¤ºä¾‹æ‰€éœ€çš„é¢å¤–ä¾èµ–ï¼š

```bash
pip install "autogen-agentchat" "autogen-ext[openai]" "mcp>=1.10.0"
```

ç¡®ä¿å·²å®‰è£… `uv` å’Œ MCP è®¡ç®—å™¨æœåŠ¡å™¨ã€‚éªŒè¯å®‰è£…ï¼š

```bash
cd examples/calc_x
python tests/test_mcp_calculator.py
```

### ç¤ºä¾‹ 1ï¼šè°ƒè¯•æ¨¡å¼è¿è¡Œæ™ºèƒ½ä½“

è¿™ä¸ªç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•è¿è¡Œä¸€ä¸ªæ•°å­¦æ¨ç†æ™ºèƒ½ä½“ï¼Œå®ƒä¼šä½¿ç”¨è®¡ç®—å™¨å·¥å…·æ¥è§£å†³æ•°å­¦é—®é¢˜ï¼š

```bash
# è¿›å…¥ç¤ºä¾‹ç›®å½•
cd examples/calc_x

# è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆéœ€è¦ OpenAI API key å’Œ base URLï¼‰
export OPENAI_API_KEY=""
export OPENAI_BASE_URL="http://127.0.0.1:8000/v1"

# è¿è¡Œè°ƒè¯•æ¨¡å¼
uv run python calc_agent.py
```

**è¿™ä¸ªç¤ºä¾‹åšäº†ä»€ä¹ˆï¼Ÿ**
- åˆ›å»ºäº†ä¸€ä¸ªæ•°å­¦é—®é¢˜æ±‚è§£æ™ºèƒ½ä½“ï¼ˆä½¿ç”¨ AutoGen æ¡†æ¶ï¼‰
- ä½¿ç”¨ MCP è®¡ç®—å™¨å·¥å…·æ¥è§£å†³æ•°å­¦é—®é¢˜
- é€šè¿‡ `@rollout` è£…é¥°å™¨å®šä¹‰æ™ºèƒ½ä½“
- ä½¿ç”¨ `agl.emit_reward` å‘é€å¥–åŠ±åˆ†æ•°
- å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ `LitAgentRunner` æ‰‹åŠ¨è¿è¡Œæ™ºèƒ½ä½“

### ç¤ºä¾‹ 2ï¼šè®­ç»ƒæ™ºèƒ½ä½“

å¦‚æœä½ æƒ³è®­ç»ƒè¿™ä¸ªæ™ºèƒ½ä½“ï¼ˆéœ€è¦æ•°æ®é›†å’Œ GPUï¼‰ï¼š

```bash
# ä¸‹è½½æ•°æ®é›†ï¼ˆä» README ä¸­çš„é“¾æ¥ï¼‰
# è§£å‹åˆ° data ç›®å½•
unzip calc-x-data.zip -d data

# å¯åŠ¨ Rayï¼ˆç”¨äºåˆ†å¸ƒå¼è®­ç»ƒï¼‰
bash ../../scripts/restart_ray.sh

# è¿è¡Œè®­ç»ƒè„šæœ¬
uv run python train_calc_agent.py --train-file data/train.parquet --val-file data/test.parquet
```

è®­ç»ƒè¿‡ç¨‹ä¼šä½¿ç”¨ VERL ç®—æ³•æ¥ä¼˜åŒ–æ™ºèƒ½ä½“çš„æ€§èƒ½ã€‚

## ğŸ“š ç¬¬å››æ­¥ï¼šå­¦ä¹ å¦‚ä½•ç¼–å†™æ™ºèƒ½ä½“

### æœ€ç®€å•çš„æ™ºèƒ½ä½“ç¤ºä¾‹

åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ `my_first_agent.py`ï¼š

```python
from typing import TypedDict
import agentlightning as agl
from agentlightning import PromptTemplate, rollout

# å®šä¹‰ä»»åŠ¡çš„æ•°æ®ç»“æ„
class SimpleTask(TypedDict):
    question: str
    expected_answer: str

# ä½¿ç”¨ @rollout è£…é¥°å™¨åˆ›å»ºæ™ºèƒ½ä½“
@rollout
def my_agent(task: SimpleTask, prompt_template: PromptTemplate) -> float:
    """
    è¿™æ˜¯ä¸€ä¸ªç®€å•çš„æ™ºèƒ½ä½“ï¼š
    1. æ¥æ”¶ä»»åŠ¡å’Œæç¤ºæ¨¡æ¿
    2. æ ¼å¼åŒ–æç¤º
    3. æ‰§è¡Œé€»è¾‘ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
    4. è¿”å›å¥–åŠ±åˆ†æ•°
    """
    # ä½¿ç”¨æç¤ºæ¨¡æ¿æ ¼å¼åŒ–è¾“å…¥
    prompt = prompt_template.format(question=task["question"])
    
    # è¿™é‡Œåº”è¯¥æ˜¯ä½ çš„æ™ºèƒ½ä½“é€»è¾‘
    # ä¾‹å¦‚ï¼šè°ƒç”¨ LLMã€ä½¿ç”¨å·¥å…·ç­‰
    print(f"å¤„ç†é—®é¢˜: {prompt}")
    
    # ç®€åŒ–ï¼šå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç®€å•çš„è¯„åˆ†å‡½æ•°
    # å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šè°ƒç”¨ LLM å¹¶è¯„ä¼°ç»“æœ
    if "hello" in task["question"].lower():
        reward = 1.0
    else:
        reward = 0.5
    
    return reward

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    # åˆ›å»ºæ•°æ®é›†
    dataset = [
        SimpleTask(question="Hello, how are you?", expected_answer="I'm fine"),
        SimpleTask(question="What is 2+2?", expected_answer="4"),
    ]
    
    # åˆ›å»ºè®­ç»ƒå™¨å¹¶è®­ç»ƒ
    trainer = agl.Trainer()
    trainer.fit(agent=my_agent, train_dataset=dataset)
```

### è¿è¡Œä½ çš„ç¬¬ä¸€ä¸ªæ™ºèƒ½ä½“

```bash
# ä¿å­˜ä¸Šé¢çš„ä»£ç åˆ° my_first_agent.py
uv run python my_first_agent.py
```

## ğŸ” ç¬¬äº”æ­¥ï¼šæ¢ç´¢é¡¹ç›®ç»“æ„

äº†è§£é¡¹ç›®ç»“æ„æœ‰åŠ©äºä½ æ›´å¥½åœ°ç†è§£ä»£ç ï¼š

```
agent-lightning/
â”œâ”€â”€ agentlightning/          # æ ¸å¿ƒä»£ç åº“
â”‚   â”œâ”€â”€ adapter/            # é€‚é…å™¨ï¼ˆå°† traces è½¬æ¢ä¸ºç®—æ³•å¯ç”¨çš„æ ¼å¼ï¼‰
â”‚   â”œâ”€â”€ algorithm/          # ç®—æ³•å®ç°ï¼ˆAPOã€VERL ç­‰ï¼‰
â”‚   â”œâ”€â”€ cli/                # å‘½ä»¤è¡Œå·¥å…·
â”‚   â”œâ”€â”€ emitter/            # å‘å°„å™¨ï¼ˆç”¨äºè®°å½• rewardsã€messages ç­‰ï¼‰
â”‚   â”œâ”€â”€ execution/          # æ‰§è¡Œç›¸å…³
â”‚   â”œâ”€â”€ litagent/           # LitAgent åŸºç±»
â”‚   â”œâ”€â”€ runner/             # è¿è¡Œå™¨ï¼ˆæ‰§è¡Œæ™ºèƒ½ä½“ï¼‰
â”‚   â”œâ”€â”€ store/              # å­˜å‚¨å®ç°
â”‚   â”œâ”€â”€ tracer/             # è¿½è¸ªå™¨ï¼ˆè®°å½• tracesï¼‰
â”‚   â””â”€â”€ trainer/            # è®­ç»ƒå™¨
â”œâ”€â”€ examples/               # ç¤ºä¾‹ä»£ç 
â”‚   â”œâ”€â”€ minimal/           # æœ€ç®€å•çš„ç¤ºä¾‹ï¼ˆæ¨èä»è¿™é‡Œå¼€å§‹ï¼‰
â”‚   â”œâ”€â”€ spider/            # SQL æ™ºèƒ½ä½“è®­ç»ƒç¤ºä¾‹
â”‚   â”œâ”€â”€ apo/               # è‡ªåŠ¨æç¤ºä¼˜åŒ–ç¤ºä¾‹
â”‚   â””â”€â”€ ...
â”œâ”€â”€ docs/                   # æ–‡æ¡£
â”‚   â”œâ”€â”€ tutorials/         # æ•™ç¨‹
â”‚   â”œâ”€â”€ how-to/            # æ“ä½œæŒ‡å—
â”‚   â””â”€â”€ ...
â””â”€â”€ tests/                  # æµ‹è¯•ä»£ç 
```

## ğŸ“– ç¬¬å…­æ­¥ï¼šæ·±å…¥å­¦ä¹ è·¯å¾„

### 1. é˜…è¯»å®˜æ–¹æ–‡æ¡£

æŒ‰é¡ºåºé˜…è¯»ä»¥ä¸‹æ–‡æ¡£ï¼š

1. **åŸºç¡€æ•™ç¨‹**ï¼ˆ`docs/tutorials/`ï¼‰ï¼š
   - `write-agents.md` - å¦‚ä½•ç¼–å†™æ™ºèƒ½ä½“
   - `traces.md` - ç†è§£è¿½è¸ªç³»ç»Ÿ
   - `installation.md` - å®‰è£…ç»†èŠ‚

2. **æ“ä½œæŒ‡å—**ï¼ˆ`docs/how-to/`ï¼‰ï¼š
   - æŸ¥çœ‹å¦‚ä½•è®­ç»ƒç‰¹å®šç±»å‹çš„æ™ºèƒ½ä½“

3. **ç®—æ³•æ–‡æ¡£**ï¼ˆ`docs/algorithm-zoo/`ï¼‰ï¼š
   - `apo.md` - è‡ªåŠ¨æç¤ºä¼˜åŒ–
   - `verl.md` - å¼ºåŒ–å­¦ä¹ ç®—æ³•

### 2. è¿è¡Œæ›´å¤šç¤ºä¾‹

```bash
# æŸ¥çœ‹æ‰€æœ‰ç¤ºä¾‹
ls examples/

# è¿è¡Œ Spider SQL ç¤ºä¾‹ï¼ˆéœ€è¦é¢å¤–ä¾èµ–ï¼‰
cd examples/spider
# å…ˆå®‰è£…ä¾èµ–ï¼špip install "langgraph<1.0" "langchain[openai]<1.0" ...
# ç„¶åè¿è¡Œï¼špython train_sql_agent.py qwen
```

### 3. ç†è§£æ ¸å¿ƒç»„ä»¶

**Tracerï¼ˆè¿½è¸ªå™¨ï¼‰**ï¼š
- `AgentOpsTracer`ï¼šè‡ªåŠ¨è¿½è¸ªæ”¯æŒçš„æ¡†æ¶ï¼ˆLangChainã€OpenAI ç­‰ï¼‰
- `OtelTracer`ï¼šæ‰‹åŠ¨åˆ›å»º OpenTelemetry spans

**Storeï¼ˆå­˜å‚¨ï¼‰**ï¼š
- `InMemoryLightningStore`ï¼šå†…å­˜å­˜å‚¨ï¼Œé€‚åˆå•æœºå¼€å‘
- `LightningStoreServer`ï¼šæœåŠ¡å™¨å­˜å‚¨ï¼Œæ”¯æŒåˆ†å¸ƒå¼

**Runnerï¼ˆè¿è¡Œå™¨ï¼‰**ï¼š
- è´Ÿè´£æ‰§è¡Œæ™ºèƒ½ä½“å¹¶æ”¶é›† traces

**Trainerï¼ˆè®­ç»ƒå™¨ï¼‰**ï¼š
- åè°ƒæ•´ä¸ªè®­ç»ƒæµç¨‹ï¼šè¿è¡Œæ™ºèƒ½ä½“ â†’ æ”¶é›† traces â†’ ç®—æ³•å­¦ä¹  â†’ æ›´æ–°èµ„æº

## ğŸ› ï¸ ç¬¬ä¸ƒæ­¥ï¼šå¸¸ç”¨å‘½ä»¤å’Œå·¥å…·

### CLI å·¥å…·

```bash
# å¯åŠ¨ Store æœåŠ¡å™¨
uv run agl store --port 45993

# æŸ¥çœ‹ vLLM ç›¸å…³å‘½ä»¤
uv run agl vllm --help

# æŸ¥çœ‹ AgentOps æœåŠ¡å™¨
uv run agl agentops --help
```

### Python API

```python
import agentlightning as agl

# åˆ›å»ºå†…å­˜å­˜å‚¨
store = agl.InMemoryLightningStore()

# åˆ›å»º Store æœåŠ¡å™¨
store_server = agl.LightningStoreServer(store, "127.0.0.1", 45993)

# åˆ›å»ºè¿½è¸ªå™¨
tracer = agl.AgentOpsTracer()

# åˆ›å»ºè®­ç»ƒå™¨
trainer = agl.Trainer()
```

## ğŸ“ ç¬¬å…«æ­¥ï¼šä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ä¿®æ”¹ç¤ºä¾‹ä»£ç **ï¼šå°è¯•ä¿®æ”¹ `examples/minimal/` ä¸­çš„ç¤ºä¾‹ï¼Œç†è§£æ¯ä¸ªç»„ä»¶çš„ä½œç”¨

2. **åˆ›å»ºè‡ªå·±çš„æ™ºèƒ½ä½“**ï¼š
   - é€‰æ‹©ä¸€ä¸ªç®€å•çš„ä»»åŠ¡ï¼ˆå¦‚é—®ç­”ã€åˆ†ç±»ç­‰ï¼‰
   - ä½¿ç”¨ `@rollout` è£…é¥°å™¨åˆ›å»ºæ™ºèƒ½ä½“
   - è¿è¡Œè®­ç»ƒçœ‹çœ‹æ•ˆæœ

3. **é˜…è¯»æºç **ï¼š
   - ä» `agentlightning/trainer/trainer.py` å¼€å§‹
   - ç†è§£è®­ç»ƒå¾ªç¯æ˜¯å¦‚ä½•å·¥ä½œçš„

4. **åŠ å…¥ç¤¾åŒº**ï¼š
   - Discord: https://discord.gg/RYk7CdvDR7
   - GitHub Issues: æé—®å’Œè®¨è®º

## â“ å¸¸è§é—®é¢˜

### Q: å¦‚ä½•è°ƒè¯•æˆ‘çš„æ™ºèƒ½ä½“ï¼Ÿ
A: ä½¿ç”¨ `agl.setup_logging("DEBUG")` å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼Œæˆ–æŸ¥çœ‹ `docs/tutorials/debug.md`

### Q: å¦‚ä½•æŸ¥çœ‹ tracesï¼Ÿ
A: ä½¿ç”¨ `store.query_spans(rollout_id)` æŸ¥è¯¢ tracesï¼Œæˆ–ä½¿ç”¨é€‚é…å™¨è½¬æ¢ä¸ºæ›´æ˜“è¯»çš„æ ¼å¼

### Q: æ”¯æŒå“ªäº›æ™ºèƒ½ä½“æ¡†æ¶ï¼Ÿ
A: æ”¯æŒ LangChainã€OpenAI Agent SDKã€AutoGenã€CrewAIã€Microsoft Agent Framework ç­‰ï¼Œç”šè‡³å¯ä»¥ä¸ä½¿ç”¨æ¡†æ¶

### Q: å¦‚ä½•é€‰æ‹©ç®—æ³•ï¼Ÿ
A: 
- **APO**ï¼šç”¨äºä¼˜åŒ–æç¤ºæ¨¡æ¿
- **VERL**ï¼šç”¨äºå¼ºåŒ–å­¦ä¹ è®­ç»ƒæ¨¡å‹æƒé‡
- æŸ¥çœ‹ `docs/algorithm-zoo/` äº†è§£è¯¦æƒ…

## ğŸ“ æ€»ç»“

ä½ ç°åœ¨å·²ç»ï¼š
- âœ… å®Œæˆäº†å®‰è£…
- âœ… ç†è§£äº†æ ¸å¿ƒæ¦‚å¿µ
- âœ… è¿è¡Œäº†ç®€å•ç¤ºä¾‹
- âœ… çŸ¥é“äº†å¦‚ä½•ç¼–å†™æ™ºèƒ½ä½“
- âœ… äº†è§£äº†é¡¹ç›®ç»“æ„

**ä¸‹ä¸€æ­¥**ï¼šé€‰æ‹©ä¸€ä¸ªä½ æ„Ÿå…´è¶£çš„ä»»åŠ¡ï¼Œå¼€å§‹åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªå¯è®­ç»ƒçš„æ™ºèƒ½ä½“ï¼

ç¥å­¦ä¹ æ„‰å¿«ï¼âš¡










# å¯åŠ¨æ”¯æŒå·¥å…·è°ƒç”¨çš„ vLLM æœåŠ¡å™¨

conda activate agent_lightning && uv run agl vllm serve /data/aj/llm_model/Qwen2.5-1.5B-Instruct \
    --enable-auto-tool-choice \
    --tool-call-parser hermes \
    --port 8000
